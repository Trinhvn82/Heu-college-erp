{% extends "layouts/base.html" %}
{% load static %}
{% load humanize %}

{% block stylesheets %}
<style>
/* Gallery & modal image styles (kept small and responsive) */
.gallery-img {
    width: 100%;
    height: 140px;
    object-fit: cover;
    cursor: pointer;
}
.gallery-label { cursor: pointer; }
.modal-dialog.custom-modal { max-width: 66.67vw; }
.modal-image-container { max-height: 80vh; display:flex; align-items:center; justify-content:center; }
.modal-image { max-width:100%; max-height:70vh; object-fit:contain; }
</style>
{% endblock stylesheets %}
{% block title %} Chi tiết Hóa đơn {% endblock %}

{% block content %}
<main class="content">
    {% include 'includes/navigation.html' %}
    {% include 'sms/alerts.html' %}

    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center py-4">
        <div class="btn-toolbar mb-2 mb-md-0">
            <ol class="breadcrumb breadcrumb-dark breadcrumb-transparent">
                <li class="breadcrumb-item"><a href="\"><span class="fas fa-home"></span></a></li>
                <li class="breadcrumb-item"><a href="{% url 'bill_list' loc_id=loc_id %}">Danh sách Hóa đơn</a></li>
                <li class="breadcrumb-item active" aria-current="page">Chi tiết Hóa đơn</li>
            </ol>
        </div>
        <div class="btn-group">
            <a href="{% url 'generate_bill_pdf' bill_id=hoadon.id %}" class="btn btn-success animate-up-2" target="_blank">
                <span class="fas fa-file-pdf me-2"></span> Tải về PDF
            </a>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card card-body bg-white border-light shadow-sm h-100">
                <h3 class="h5 mb-3 border-bottom pb-2">Hóa đơn: {{ hoadon.ten }} | {{ hoadon.house.ten }}</h3>

                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                        <strong>TỔNG CỘNG PHẢI THU:</strong>
                        <strong class="text-success h5">{{ hoadon.TONG_CONG|intcomma }} VNĐ</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Tiền thuê nhà:
                        <span>{{ hoadon.tienthuenha|intcomma }} VNĐ</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Tiền Điện:
                        <span>{{ hoadon.tiendien|intcomma }} VNĐ (Cũ: {{ hoadon.chi_so_dien_cu }} -> Mới: {{ hoadon.chi_so_dien_moi }})</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Tiền Nước:
                        <span>{{ hoadon.tiennuoc|intcomma }} VNĐ (Cũ: {{ hoadon.chi_so_nuoc_cu }} -> Mới: {{ hoadon.chi_so_nuoc_moi }})</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Chi phí Khác:
                        <span>{{ hoadon.tienkhac|intcomma }} VNĐ</span>
                    </li>
                </ul>
                
                <div class="mt-4">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <p class="mb-1 text-muted">Đã trả</p>
                            <h4 class="text-info">{{ hoadon.SO_TIEN_DA_TRA|intcomma }} VNĐ</h4>
                        </div>
                        <div class="col-md-4">
                            <p class="mb-1 text-muted">Công nợ</p>
                            <h4 class="text-danger">{{ hoadon.CONG_NO|intcomma }} VNĐ</h4>
                        </div>
                        <div class="col-md-4">
                            <p class="mb-1 text-muted">Trạng thái</p>
                            {% if hoadon.status == 'DaTT' %}
                                <span class="badge bg-success text-white">Đã Thanh toán</span>
                            {% elif hoadon.status == 'QuaHan' %}
                                <span class="badge bg-danger text-white">QUÁ HẠN</span>
                            {% elif hoadon.status == 'DangTT' %}
                                <span class="badge bg-warning text-dark">Đang Thanh toán</span>
                            {% else %}
                                <span class="badge bg-secondary text-white">Chưa Thanh toán</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="mt-3 small text-muted border-top pt-2">
                    <p class="mb-1">Ngày hết hạn: **{{ hoadon.duedate|date:"d/m/Y" }}**</p>
                    <p class="mb-0">Ghi chú: {{ hoadon.ghichu|default:"Không có" }}</p>
                </div>
            </div>

<div class="card card-body bg-white border-light shadow-sm mb-4">
    <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
        <h3 class="h5 mb-0">
            <button class="btn btn-link text-decoration-none p-0 text-dark collapsed" type="button" 
                    data-bs-toggle="collapse" data-bs-target="#collapseEvidences" 
                    aria-expanded="false" aria-controls="collapseEvidences">
                <span class="fas fa-chevron-right me-2 collapse-icon"></span>
                Minh chứng File
                {% if lich_su_file %}<span class="badge bg-secondary ms-2">{{ lich_su_file|length }}</span>{% endif %}
            </button>
        </h3>
    </div>

    <div class="collapse" id="collapseEvidences">
        <div class="row mb-3">
            <div class="col-12">
                <!-- Full-width upload button (occupies the whole left 6-column area) -->
                <button type="button" class="btn btn-primary w-100 animate-up-2" 
                    data-bs-toggle="modal" 
                    data-bs-target="#uploadFileModal">
                        <span class="fas fa-upload me-2"></span> Tải lên
                </button>
            </div>
        </div>

        <div class="row g-3">
        {% for file in lich_su_file %}
            <div class="col-lg-6 col-md-6 col-sm-12">
                <div class="card h-100 shadow-sm gallery-item">
                    <div class="row g-0 align-items-center">
                        <div class="col-auto p-2" style="width:110px">
                            {% with file_name=file.file.name|lower %}
                                {% if file_name|slice:"-4:" == ".jpg" or file_name|slice:"-4:" == ".png" or file_name|slice:"-5:" == ".jpeg" or file_name|slice:"-5:" == ".webp" %}
                                    <a href="#" data-bs-toggle="modal" data-bs-target="#fileModal-{{ file.id }}">
                                        <img src="{{ file.file.url }}" alt="{{ file.mota }}" class="gallery-img rounded">
                                    </a>
                                {% else %}
                                    <div class="d-flex flex-column justify-content-center align-items-center h-100 bg-light text-secondary rounded" style="width:100%;height:110px;">
                                        <span class="fas fa-file-pdf fa-2x"></span>
                                        <small class="text-uppercase">PDF</small>
                                    </div>
                                {% endif %}
                            {% endwith %}
                        </div>
                        <div class="col">
                            <div class="card-body py-2">
                                <h6 class="mb-1 gallery-label">{{ file.mota|default:file.file.name|truncatechars:60 }}</h6>
                                <small class="text-muted d-block">Người tải: {{ file.user.username|default:file.uploaded_by }} • {{ file.uploaded_at|date:"d/m/Y H:i" }}</small>
                            </div>
                        </div>
                        <div class="col-auto p-2">
                            <div class="d-flex align-items-center flex-nowrap">
                                <small class="text-muted me-3 d-none d-sm-inline">{{ file.uploaded_at|date:"d/m/Y H:i" }}</small>

                                <!-- Short download button -->
                                <a href="{% url 'download_file' file_id=file.id %}" class="btn btn-sm btn-outline-secondary me-2 flex-shrink-0" title="Tải" role="button">
                                    <span class="fas fa-download"></span>
                                </a>

                                <div class="dropdown flex-shrink-0">
                                    <button class="btn btn-link text-dark dropdown-toggle m-0 p-0" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <span class="icon icon-sm"><span class="fas fa-ellipsis-h icon-dark"></span></span>
                                    </button>
                                    <div class="dropdown-menu dashboard-dropdown dropdown-menu-end mt-2">
                                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#fileModal-{{ file.id }}">
                                            <span class="fas fa-eye me-2"></span> Xem
                                        </a>
                                        <div class="dropdown-divider"></div>
                                        {% if perms.sms.delete_uploadedfile or file.user == user %}
                                            <button type="button" class="dropdown-item text-danger confirm-delete-btn"
                                                    data-delete-url="{% url 'delete_file' file_id=file.id %}"
                                                    data-file-name="{{ file.mota|default:file.file.name }}">
                                                <span class="fas fa-trash-alt me-2"></span> Xóa
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Confirm Delete Modal -->
                        <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="confirmDeleteModalLabel">Xác nhận xóa</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <form id="confirmDeleteForm" method="post" action="">
                                        {% csrf_token %}
                                        <div class="modal-body">
                                            <p>Bạn có chắc chắn muốn xóa tập tin <strong id="confirmDeleteFileName"></strong> không?</p>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                            <button type="submit" class="btn btn-danger">Xóa</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal for file preview -->
                <div class="modal fade" id="fileModal-{{ file.id }}" tabindex="-1" aria-labelledby="fileModalLabel-{{ file.id }}" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered custom-modal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="fileModalLabel-{{ file.id }}">{{ file.mota|default:"Tập tin" }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-0">
                                <div class="modal-image-container p-3">
                                    {% with file_name=file.file.name|lower %}
                                        {% if file_name|slice:"-4:" == ".jpg" or file_name|slice:"-4:" == ".png" or file_name|slice:"-5:" == ".jpeg" or file_name|slice:"-5:" == ".webp" %}
                                            <img src="{{ file.file.url }}" class="modal-image rounded" alt="{{ file.mota }}">
                                        {% else %}
                                            <div class="text-center p-4 w-100">
                                                <i class="fas fa-file-pdf fa-4x text-danger mb-3"></i>
                                                <h5 class="mb-2">{{ file.mota|default:"Tài liệu PDF" }}</h5>
                                                <p class="mb-3 small text-muted">Nhấn nút bên dưới để mở PDF trong tab mới.</p>
                                                <a href="{{ file.file.url }}" class="btn btn-primary" target="_blank">
                                                    <i class="fas fa-external-link-alt me-2"></i>Mở PDF
                                                </a>
                                            </div>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="col-12">
                <div class="alert alert-info small text-center m-3">Chưa có file minh chứng nào được tải lên.</div>
            </div>
        {% endfor %}
    </div>
</div>

        <div class="col-lg-6">
            <div class="card card-body bg-white border-light shadow-sm h-100">
                <h3 class="h5 mb-3 border-bottom pb-2">Ghi nhận Thanh toán</h3>
                
                {% if hoadon.status == 'DaTT' %}
                    <div class="alert alert-success text-dark">
                            <span class="fas fa-check-circle me-2"></span>
                            <strong>Hóa đơn này đã được thanh toán đủ.</strong>
                    </div>
                {% else %}

                    <!-- Button to open modal for adding payment -->
                    <button type="button" class="btn btn-primary animate-up-2" data-bs-toggle="modal" data-bs-target="#addPaymentModal">
                        <span class="fas fa-plus-circle me-2"></span> Ghi nhận Thanh toán
                    </button>

                    <!-- Modal: Add Payment -->
                    <div class="modal fade" id="addPaymentModal" tabindex="-1" aria-labelledby="addPaymentModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="addPaymentModalLabel">Ghi nhận Thanh toán</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <form method="post" action="{% url 'add_payment' bill_id=hoadon.id %}">
                                    {% csrf_token %}
                                    <div class="modal-body">
                                        <div class="mb-3">
                                            <label for="{{ payment_form.tientt.id_for_label }}" class="form-label">{{ payment_form.tientt.label }}</label>
                                            {{ payment_form.tientt }}
                                            {% if payment_form.tientt.errors %}<div class="text-danger small">{{ payment_form.tientt.errors }}</div>{% endif %}
                                        </div>
                                        <div class="mb-3">
                                            <label for="{{ payment_form.ghichu.id_for_label }}" class="form-label">{{ payment_form.ghichu.label }}</label>
                                            {{ payment_form.ghichu }}
                                            {% if payment_form.ghichu.errors %}<div class="text-danger small">{{ payment_form.ghichu.errors }}</div>{% endif %}
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                        <button type="submit" class="btn btn-primary">Ghi nhận Thanh toán</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                {% endif %}
                
                <hr class="my-4">


                <h3 class="h5 mb-3">Lịch sử Thanh toán ({{ lich_su_thanh_toan|length }} lần)</h3>
                
                {% for tt in lich_su_thanh_toan %}
                    {% if tt.status == 'Daxn' %}
                        {% with tt_status_class="success" tt_status_text="Đã Xác nhận" %}
                        {% endwith %}
                    {% elif tt.status == 'Choxn' %}
                        {% with tt_status_class="warning" tt_status_text="Chờ Xác nhận" %}
                        {% endwith %}
                    {% endif %}

                    <div class="border-bottom pb-2 mb-2">
                        <div class="d-flex justify-content-between align-items-center small">
                            
                            <span>
                                <span class="fas fa-money-bill-alt me-1 text-{{ tt_status_class }}"></span> 
                                **{{ tt.tientt|intcomma }} VNĐ**
                                <span class="badge bg-{% if tt.status == 'Daxn'%}success{% elif tt.status == 'Choxn' %}warning{% else %}secondary{% endif %} text-dark">{%if tt.status == 'Daxn'%}Đã Xác nhận{% elif tt.status == 'Choxn' %}Chờ Xác nhận{% else %}Đã Hủy{% endif %}   </span>
                            </span>
                            
                            <span class="dropdown">
                                <span class="text-muted me-3">{{ tt.ngay_tao|date:"d/m/Y H:i" }}</span>

                                    <button class="btn btn-link text-dark dropdown-toggle m-0 p-0" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <span class="icon icon-sm"><span class="fas fa-ellipsis-h icon-dark"></span></span>
                                </button>
                                <div class="dropdown-menu dashboard-dropdown dropdown-menu-right mt-2">
                                    
                                    {% if tt.status == 'Choxn' %}
                                    <a class="dropdown-item text-success"
                                        href="{% url 'confirm_payment' payment_id=tt.id %}">
                                        <span class="fas fa-check-circle me-2"></span> XÁC NHẬN TT
                                    </a>
                                    {% endif %}

                                    <a class="dropdown-item text-danger"
                                        href="{% url 'delete_payment' payment_id=tt.id %}"
                                        onclick="return confirm('Bạn có chắc chắn muốn xóa bản ghi thanh toán này không? Điều này sẽ cập nhật lại Công nợ.')">
                                        <span class="fas fa-trash-alt me-2"></span> XÓA
                                    </a>
                                </div>
                            </span>
                        </div>
                        <p class="small mb-0 text-dark">
                            Người tạo: {{ tt.user.username|default:"N/A" }} | Ghi chú: {{ tt.ghichu|default:"Không có" }}
                        </p>
                    </div>
                {% empty %}
                    <div class="alert alert-secondary small text-center">
                        <span class="fas fa-info-circle me-1"></span>
                        Chưa có lần thanh toán nào được ghi nhận.
                    </div>
                {% endfor %}

            </div>
        </div>
    </div>

    <div class="modal fade" id="uploadFileModal" tabindex="-1" aria-labelledby="uploadFileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadFileModalLabel">Tải lên Minh chứng Hóa đơn</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="uploadFileForm" action="{% url 'upload_bill_file' bill_id=hoadon.id %}" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="{{ bill_file_form.file.id_for_label }}" class="form-label">Chọn File (Ảnh/PDF)</label>
                            {{ bill_file_form.file }}
                        </div>
                        <div class="mb-3">
                            <label for="{{ bill_file_form.mota.id_for_label }}" class="form-label">Mô tả File (*)</label>
                            {{ bill_file_form.mota }}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary">
                            <span class="fas fa-upload me-2"></span> Tải lên
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
   

</main>
{% endblock content %}

{% block javascripts %}
<script>
    // Rotate chevron icon when evidence section toggles
    document.addEventListener('DOMContentLoaded', function() {
        const collapseSection = document.getElementById('collapseEvidences');
        const chevronIcon = document.querySelector('.collapse-icon');
        
        if (collapseSection && chevronIcon) {
            collapseSection.addEventListener('show.bs.collapse', function () {
                chevronIcon.style.transform = 'rotate(90deg)';
                chevronIcon.style.transition = 'transform 0.2s';
            });
            
            collapseSection.addEventListener('hide.bs.collapse', function () {
                chevronIcon.style.transform = 'rotate(0deg)';
                chevronIcon.style.transition = 'transform 0.2s';
            });
        }
    });

    // Hàm này phải có để Form Thanh toán hoạt động
    function formatThousands(input) {
        let rawValue = input.value.replace(/[^0-9]/g, ''); 
        if (rawValue) {
            let formattedValue = rawValue.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            input.value = formattedValue;
        }
    }

    function preventNonNumeric(event) {
        const key = event.key;
        if (key >= '0' && key <= '9') {
            return; 
        }
        if ([
            'Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab', 'Enter', 'Home', 'End'
        ].includes(key)) {
            return;
        }
        if ((event.ctrlKey || event.metaKey) && ['a', 'c', 'v', 'x', 'r'].includes(key.toLowerCase())) {
            return; 
        }
        event.preventDefault();
    }

    // Gallery: mở modal khi nhấp đúp vào ảnh hoặc label
    document.addEventListener('DOMContentLoaded', function() {
        function showModalFromElement(el) {
            const galleryItem = el.closest('.gallery-item');
            if (!galleryItem) return;
            // support both data-target (BS4) and data-bs-target (BS5)
            const trigger = galleryItem.querySelector('[data-target],[data-bs-target]');
            if (!trigger) return;
            const modalSelector = trigger.getAttribute('data-target') || trigger.getAttribute('data-bs-target');
            const modalEl = document.querySelector(modalSelector);
            if (!modalEl) return;
            // Try Bootstrap modal (works for BS4/BS5)
            if (window.bootstrap && bootstrap.Modal) {
                try { const modal = new bootstrap.Modal(modalEl); modal.show(); return; } catch(e) {}
            }
            // Fallback: use jQuery/BS4 modal if available
            if (window.jQuery && typeof jQuery(modalEl).modal === 'function') {
                jQuery(modalEl).modal('show');
                return;
            }
            // If no modal library, just make it visible (best-effort)
            modalEl.classList.add('show');
            modalEl.style.display = 'block';
        }

        document.querySelectorAll('.gallery-img').forEach(function(img) {
            img.addEventListener('dblclick', function() { showModalFromElement(this); });
        });

        document.querySelectorAll('.gallery-label').forEach(function(lbl) {
            lbl.addEventListener('dblclick', function() { showModalFromElement(this); });
            lbl.style.cursor = 'pointer';
        });

        // Attach formatting handlers to payment input (if present)
        try {
            var paymentInput = document.getElementById("{{ payment_form.tientt.id_for_label }}");
            if (paymentInput) {
                paymentInput.addEventListener('input', function() { formatThousands(this); });
                paymentInput.addEventListener('keydown', preventNonNumeric);
            }
        } catch (e) {
            // ignore if template variable isn't present
        }

        // Reset upload form when modal closes
        var uploadModalEl = document.getElementById('uploadFileModal');
        if (uploadModalEl) {
            uploadModalEl.addEventListener('hidden.bs.modal', function (event) {
                var f = document.getElementById('uploadFileForm');
                if (f) f.reset();
            });
        }
    
        // Confirm delete via Bootstrap modal (bill_detail)
        var confirmModalEl = document.getElementById('confirmDeleteModal');
        if (confirmModalEl) {
            var confirmModal = new bootstrap.Modal(confirmModalEl);
            document.querySelectorAll('.confirm-delete-btn').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    var url = btn.getAttribute('data-delete-url');
                    var fname = btn.getAttribute('data-file-name') || '';
                    document.getElementById('confirmDeleteForm').setAttribute('action', url);
                    document.getElementById('confirmDeleteFileName').textContent = fname;
                    confirmModal.show();
                });
            });
        }
    });
</script>
{% endblock javascripts %}
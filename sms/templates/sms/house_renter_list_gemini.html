{% extends "layouts/rental_base.html" %}
{% load static %}
{% load humanize %} 

{% block title %} Lịch sử Thuê nhà {% endblock %}

{% block extra_css %}
<style>
/* ----------------------------------
 * CSS Timeline - Dòng thời gian đẹp
 * ---------------------------------- */

.timeline {
    list-style: none;
    padding: 30px 0;
    position: relative;
    margin: 0;
}

/* Đường kẻ dọc chính giữa */
.timeline:before {
    top: 0;
    bottom: 0;
    position: absolute;
    content: "";
    width: 4px;
    background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
    left: 50%;
    margin-left: -2px;
    border-radius: 2px;
}

/* Các mục timeline */
.timeline-item {
    margin-bottom: 50px;
    position: relative;
    min-height: 50px;
}

/* Clearfix */
.timeline-item:before,
.timeline-item:after {
    content: "";
    display: table;
}

.timeline-item:after {
    clear: both;
}

/* Panel chứa nội dung */
.timeline-panel {
    float: left;
    border-radius: 4px;
    position: relative;
    padding: 0;
}

/* Tablet and up: each panel ~25% of full width */
@media (min-width: 768px) {
    .timeline-panel { width: 45% !important; max-width: 45%; }
}

/* Căn panel bên phải cho item chẵn */
.timeline-item:nth-child(even) .timeline-panel {
    float: right;
}

/* Mũi tên trỏ vào timeline (optional) */
.timeline-panel:before {
    content: "";
    position: absolute;
    top: 26px;
    right: -15px;
    width: 0;
    height: 0;
    border-style: solid;
    border-width: 10px 0 10px 15px;
    border-color: transparent transparent transparent #fff;
}

.timeline-item:nth-child(even) .timeline-panel:before {
    left: -15px;
    right: auto;
    border-width: 10px 15px 10px 0;
    border-color: transparent #fff transparent transparent;
}

/* Nút tròn/Badge */
.timeline-badge {
    color: #fff;
    width: 50px;
    height: 50px;
    line-height: 50px;
    font-size: 1.4em;
    text-align: center;
    position: absolute;
    top: 16px;
    left: 50%;
    margin-left: -25px;
    background-color: #999999; /* Màu mặc định */
    z-index: 100;
    border-radius: 50%;
}



/* Responsive cho màn hình nhỏ */
@media(max-width: 991px) {
    .timeline:before {
        left: 30px;
    }
    .timeline-item {
        margin-left: 0;
    }
    .timeline-panel {
        width: calc(100% - 80px);
        float: none !important;
        margin-left: 80px;
    }
    .timeline-panel:before {
        display: none;
    }
    .timeline-item:nth-child(even) .timeline-panel {
        float: none !important;
        margin-left: 80px;
    }
    .timeline-badge {
        left: 30px;
        margin-left: -25px;
    }
}
</style>
{% endblock extra_css %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('createHRForm');
        const modal = document.getElementById('createHRModal');
        const modalInstance = new bootstrap.Modal(modal);
        const timelineWrapper = document.getElementById('hr-timeline-wrapper');

        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(form);
                const submitBtn = form.querySelector('button[type="submit"]');
                
                // Disable submit button
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Đang lưu...';
                
                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'HX-Request': 'true'
                    }
                })
                .then(response => response.text())
                .then(html => {
                    // Update timeline
                    timelineWrapper.innerHTML = html;
                    
                    // Close modal
                    modalInstance.hide();
                    
                    // Reset form
                    form.reset();
                    
                    // Show success message
                    alert('Thêm hợp đồng thành công!');
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi lưu hợp đồng!');
                })
                .finally(() => {
                    // Re-enable submit button
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>Lưu Hợp đồng';
                });
            });
        }
    });
</script>
{% endblock %}

{% block breadcrumb %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'index1' %}"><i class="fas fa-home"></i></a></li>
        <li class="breadcrumb-item"><a href="{% url 'loc_list' %}">Vị trí</a></li>
        <li class="breadcrumb-item active" aria-current="page">Lịch sử thuê nhà</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-12">
                        <h2 class="h5 mb-4 text-center border-bottom pb-2">Dòng thời gian thuê nhà</h2>
                        
                        <div
                            id="hr-timeline-wrapper"
                            hx-get="{% url 'hr_list_partial_secure' id %}"
                            hx-trigger="refresh-hr-list"
                            hx-swap="innerHTML"
                        >
                            {% include 'sms/fragments/_hr_timeline_list.html' with hrs=hrs id=id %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

<!-- Modal: Tạo Hợp đồng Mới -->
<div class="modal fade" id="createHRModal" tabindex="-1" aria-labelledby="createHRModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createHRModalLabel">
                    <i class="fas fa-file-signature me-2"></i>Tạo Hợp đồng Thuê Mới
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createHRForm" method="post" action="{% url 'create_hr_secure' id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        {% for field in forms %}
                            <div class="col-md-6 mb-3">
                                <label class="form-label">{{ field.label }}</label>
                                {{ field }}
                                {% if field.errors %}
                                    <div class="text-danger small">{{ field.errors }}</div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Lưu Hợp đồng
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock content %}
<div class="modal-header">
  <h5 class="modal-title">
    <i class="fas fa-info-circle me-2"></i>Chi tiết sự cố
  </h5>
  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
  <!-- Tabs -->
  <ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabInfo">
        <i class="fas fa-info-circle me-1"></i>Thông tin
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabImages">
        <i class="fas fa-images me-1"></i>Hình ảnh <span class="badge bg-secondary">{{ images|length }}</span>
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabComments">
        <i class="fas fa-comments me-1"></i>Bình luận <span class="badge bg-secondary">{{ comments|length }}</span>
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabHistory">
        <i class="fas fa-history me-1"></i>Lịch sử
      </button>
    </li>
  </ul>

  <div class="tab-content">
    <!-- Tab: Info -->
    <div class="tab-pane fade show active" id="tabInfo">
      <div class="row g-3">
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h6 class="mb-1">{{ issue.title }}</h6>
              <small class="text-muted">
                <i class="fas fa-home me-1"></i>{{ issue.house.ten }} | 
                <i class="fas fa-user me-1"></i>{{ issue.renter.hoten }}
              </small>
            </div>
            <div>
              {% if issue.status == 'new' %}
                <span class="badge bg-warning text-dark">Mới</span>
              {% elif issue.status == 'in_progress' %}
                <span class="badge bg-info text-white">Đang xử lý</span>
              {% elif issue.status == 'pending_confirmation' %}
                <span class="badge bg-primary text-white">Chờ xác nhận</span>
              {% elif issue.status == 'resolved' %}
                <span class="badge bg-success text-white">Đã xử lý</span>
              {% elif issue.status == 'rejected' %}
                <span class="badge bg-danger text-white">Chưa xong</span>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="col-12">
          <label class="form-label fw-bold small text-muted">Mô tả</label>
          <p class="mb-0" style="white-space: pre-wrap;">{{ issue.description }}</p>
        </div>

        <div class="col-md-6">
          <label class="form-label fw-bold small text-muted">Thời gian báo cáo</label>
          <p class="mb-0">
            <i class="fas fa-clock me-1"></i>{{ issue.created_at|date:'d/m/Y H:i' }}
          </p>
        </div>

        {% if issue.resolved_at %}
        <div class="col-md-6">
          <label class="form-label fw-bold small text-muted">Thời gian xử lý xong</label>
          <p class="mb-0 text-success">
            <i class="fas fa-check-circle me-1"></i>{{ issue.resolved_at|date:'d/m/Y H:i' }}
          </p>
        </div>
        {% endif %}

        <div class="col-12">
          <label class="form-label fw-bold small text-muted">Cập nhật lần cuối</label>
          <p class="mb-0">{{ issue.updated_at|date:'d/m/Y H:i' }}</p>
        </div>

        {% if is_renter and issue.status == 'pending_confirmation' %}
        <div class="col-12">
          <div class="alert alert-warning">
            <div class="d-flex align-items-center">
              <i class="fas fa-check-circle fa-2x me-3 text-warning"></i>
              <div>
                <strong>Chủ nhà đã đánh dấu đã xử lý xong</strong>
                <p class="mb-0 small">Vui lòng kiểm tra và xác nhận bằng các nút ở phía dưới.</p>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        {% if is_landlord and issue.status != 'resolved' and issue.status != 'pending_confirmation' %}
        <div class="col-12">
          <form method="post" action="{% url 'change_issue_status' issue.id %}">
            {% csrf_token %}
            <div class="input-group">
              <select name="status" class="form-select">
                <option value="in_progress" {% if issue.status == 'in_progress' %}selected{% endif %}>Đang xử lý</option>
                <option value="resolved">Đã xử lý</option>
              </select>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-1"></i>Cập nhật trạng thái
              </button>
            </div>
          </form>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Tab: Images -->
    <div class="tab-pane fade" id="tabImages">
      {% if images %}
        <div class="row g-2">
          {% for img in images %}
          <div class="col-md-4">
            <a href="{{ img.image.url }}" target="_blank">
              <img src="{{ img.image.url }}" class="img-fluid rounded" alt="{{ img.caption }}">
            </a>
            {% if img.caption %}
            <small class="text-muted d-block mt-1">{{ img.caption }}</small>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-center text-muted py-4">
          <i class="fas fa-image fa-2x mb-2"></i>
          <p>Chưa có hình ảnh nào</p>
        </div>
      {% endif %}
    </div>

    <!-- Tab: Comments -->
    <div class="tab-pane fade" id="tabComments">
      <div id="commentsList">
        {% for comment in comments %}
          {% include 'sms/partials/comment_item.html' with comment=comment is_landlord=is_landlord %}
        {% empty %}
          <div class="text-center text-muted py-3">
            <i class="fas fa-comments fa-2x mb-2"></i>
            <p>Chưa có bình luận nào. Hãy là người đầu tiên!</p>
          </div>
        {% endfor %}
      </div>

      <!-- Comment form -->
      <form method="post" 
            action="{% url 'add_issue_comment' issue.id %}"
            hx-post="{% url 'add_issue_comment' issue.id %}"
            hx-target="#commentsList"
            hx-swap="beforeend"
         hx-on::after-request="this.reset()"
            class="mt-3">
        {% csrf_token %}
        <div class="mb-2">
          {{ comment_form.comment }}
        </div>
        <button type="submit" class="btn btn-sm btn-primary">
          <i class="fas fa-paper-plane me-1"></i>Gửi bình luận
        </button>
      </form>
    </div>

    <!-- Tab: History -->
    <div class="tab-pane fade" id="tabHistory">
      {% if status_history %}
        <div class="timeline">
          {% for h in status_history %}
          <div class="d-flex mb-3">
            <div class="me-3">
              <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" 
                   style="width: 36px; height: 36px;">
                <i class="fas fa-exchange-alt"></i>
              </div>
            </div>
            <div class="flex-grow-1">
              <div class="d-flex justify-content-between">
                <strong>{{ h.changed_by.username }}</strong>
                <small class="text-muted">{{ h.changed_at|date:'d/m/Y H:i' }}</small>
              </div>
              <p class="mb-0">
                Đã chuyển từ 
                <span class="badge bg-secondary text-white">{{ h.get_old_status_display }}</span>
                sang 
                <span class="badge bg-primary text-white">{{ h.get_new_status_display }}</span>
              </p>
              {% if h.note %}
              <small class="text-muted">{{ h.note }}</small>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-center text-muted py-4">
          <i class="fas fa-history fa-2x mb-2"></i>
          <p>Chưa có lịch sử thay đổi</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>
<div class="modal-footer">
  {% if is_landlord and issue.status != 'resolved' and issue.status != 'pending_confirmation' %}
    <a href="{% url 'resolve_issue' issue.id %}" class="btn btn-success">
      <i class="fas fa-check me-1"></i>Đánh dấu đã xử lý
    </a>
  {% endif %}
  
  {% if is_renter and issue.status == 'pending_confirmation' %}
    <form method="post" action="{% url 'renter_confirm_issue' issue.id %}" style="display: inline;"
          hx-post="{% url 'renter_confirm_issue' issue.id %}"
          hx-swap="none"
          hx-on::after-request="if(event.detail.successful) { bootstrap.Modal.getInstance(document.getElementById('issueModal')).hide(); setTimeout(() => { window.location.reload(); }, 500); }">
      {% csrf_token %}
      <input type="hidden" name="action" value="confirm">
      <button type="submit" class="btn btn-success text-white">
        <i class="fas fa-check-circle me-1"></i>Xác nhận đã xong
      </button>
    </form>
    
    <button type="button" class="btn btn-warning text-white" data-bs-toggle="collapse" data-bs-target="#rejectForm">
      <i class="fas fa-times-circle me-1"></i>Chưa xong
    </button>
  {% endif %}
  
  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
    <i class="fas fa-times me-1"></i>Đóng
  </button>
</div>

<!-- Reject form collapse (shown when "Chưa xong" is clicked) -->
{% if is_renter and issue.status == 'pending_confirmation' %}
<div class="collapse mt-3 px-3 pb-3" id="rejectForm">
  <div class="card card-body border-warning">
    <h6 class="text-warning mb-3">
      <i class="fas fa-times-circle me-2"></i>Lý do từ chối
    </h6>
    <form method="post" action="{% url 'renter_confirm_issue' issue.id %}"
          hx-post="{% url 'renter_confirm_issue' issue.id %}"
          hx-swap="none"
          hx-on::after-request="if(event.detail.successful) { bootstrap.Modal.getInstance(document.getElementById('issueModal')).hide(); setTimeout(() => { window.location.reload(); }, 500); }">
      {% csrf_token %}
      <input type="hidden" name="action" value="reject">
      <div class="mb-3">
        <label class="form-label small text-muted">Vui lòng cho biết lý do để chủ nhà có thể xử lý lại:</label>
        <textarea name="note" class="form-control" placeholder="Nhập lý do từ chối (tùy chọn)" rows="3" autofocus></textarea>
      </div>
      <div class="text-end">
        <button type="button" class="btn btn-sm btn-secondary" data-bs-toggle="collapse" data-bs-target="#rejectForm">
          <i class="fas fa-times me-1"></i>Hủy
        </button>
        <button type="submit" class="btn btn-sm btn-warning text-dark">
          <i class="fas fa-paper-plane me-1"></i>Gửi phản hồi
        </button>
      </div>
    </form>
  </div>
</div>
{% endif %}

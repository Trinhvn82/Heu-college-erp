{% extends "layouts/renter_base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Dashboard Khách thuê - {{ renter.hoten }}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active">Dashboard Khách thuê</li>
{% endblock %}

{% block extra_css %}
<style>
    .info-card {
        border-radius: 15px;
        border: none;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        height: 100%;
    }
    
    .info-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.12);
    }
    
    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }
    
    .icon-primary {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        color: #667eea;
    }
    
    .icon-success {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
        color: #10b981;
    }
    
    .icon-warning {
        background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(245, 158, 11, 0.1) 100%);
        color: #fbbf24;
    }
    
    .icon-danger {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);
        color: #ef4444;
    }
    
    .icon-info {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.1) 100%);
        color: #3b82f6;
    }
    
    .stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: #2d3748;
        line-height: 1.2;
    }
    
    .stat-label {
        color: #718096;
        font-size: 0.8rem;
        font-weight: 500;
        line-height: 1.3;
    }
    
    .contract-card {
        border-left: 4px solid #667eea;
        transition: all 0.3s ease;
    }
    
    .contract-card:hover {
        border-left-color: #764ba2;
        background: #f7fafc;
    }
    
    .contract-active {
        border-left-color: #10b981;
    }
    
    .contract-inactive {
        border-left-color: #9ca3af;
    }
    
    .bill-row {
        transition: all 0.3s ease;
    }
    
    .bill-row:hover {
        background: #f7fafc;
        transform: translateX(5px);
    }
    
    .badge-status {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.75rem;
    }
    
    .welcome-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }
    
    /* Use a unique class to avoid conflict with global .section-header in volt.css */
    .r-section-header {
        margin-bottom: 0.5rem;
        padding-bottom: 0.25rem;
        border-bottom: 2px solid #e2e8f0;
    }
    
    .r-section-header h3 {
        font-size: 1.1rem;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 0;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #718096;
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.3;
    }
</style>
{% endblock %}

{% block content %}
<!-- Welcome Header -->
<div class="welcome-header mb-3">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h2 class="mb-2">
                <span class="fas fa-user-circle me-2"></span>
                Xin chào, {{ renter.hoten }}!
            </h2>
            <p class="mb-0 opacity-75">
                Chào mừng bạn đến với trang quản lý hợp đồng và hóa đơn
            </p>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
            <div class="text-white">
                <div><small>Mã khách thuê</small></div>
                <div class="h5 mb-0">{{ renter.ma|default:"N/A" }}</div>
            </div>
        </div>
    </div>
</div>

<!-- Debt Alert -->
{% if total_debt > 0 %}
<div class="alert alert-warning mb-2" role="alert" style="background-color: #fff3cd; border-color: #ffc107;">
    <div class="d-flex align-items-center">
        <i class="fas fa-exclamation-triangle fa-2x me-3 text-warning"></i>
        <div style="color: #856404;">
            <h5 class="mb-1" style="color: #856404; font-weight: 700;">Thông báo công nợ</h5>
            <p class="mb-0" style="color: #856404; font-size: 1rem;">
                Bạn đang có <strong style="color: #dc3545; font-size: 1.2rem;">{{ total_debt|floatformat:0|intcomma }} VNĐ</strong> công nợ chưa thanh toán. 
                Vui lòng liên hệ chủ nhà để thanh toán.
            </p>
        </div>
    </div>
</div>
{% endif %}

<div class="row">
    <!-- Contracts Section -->
    <div class="col-lg-6 mb-2">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-2">
                <div class="r-section-header mb-2">
                    <h3 class="mb-0">
                        <span class="fas fa-file-contract text-primary me-2"></span>
                        Hợp đồng thuê
                    </h3>
                </div>
                
                {% if contracts %}
                    <div class="list-group list-group-flush">
                        {% for contract in contracts %}
                        <div class="list-group-item contract-card {% if contract.active %}contract-active{% else %}contract-inactive{% endif %} mb-2 p-2">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <div>
                                    <h5 class="mb-1 h6">
                                        <span class="fas fa-home me-2"></span>
                                        {{ contract.house.ten|default:"N/A" }}
                                    </h5>
                                    {% if contract.house.loc %}
                                    <p class="text-muted small mb-0">
                                        <span class="fas fa-map-marker-alt me-1"></span>
                                        {{ contract.house.loc.diachi }}
                                    </p>
                                    {% endif %}
                                </div>
                                {% if contract.active %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-check-circle me-1"></i>Đang hiệu lực
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-times-circle me-1"></i>Đã kết thúc
                                    </span>
                                {% endif %}
                            </div>
                            
                            <div class="row g-2 mt-1">
                                <div class="col-6">
                                    <small class="text-muted">
                                        <i class="fas fa-calendar-plus me-1"></i>Từ ngày:
                                    </small>
                                    <div class="fw-semibold small">{{ contract.rent_from|date:"d/m/Y" }}</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">
                                        <i class="fas fa-calendar-minus me-1"></i>Đến ngày:
                                    </small>
                                    <div class="fw-semibold small">{{ contract.rent_to|date:"d/m/Y" }}</div>
                                </div>
                            </div>
                            
                            <div class="mt-1">
                                <small class="text-muted">
                                    <i class="fas fa-dollar-sign me-1"></i>Giá thuê:
                                </small>
                                <span class="fw-bold text-primary small">
                                    {{ contract.house.permonth|floatformat:0 }} VNĐ/tháng
                                </span>
                            </div>
                            
                            {% if contract.ghichu %}
                            <div class="mt-1">
                                <small class="text-muted">
                                    <i class="fas fa-comment me-1"></i>Ghi chú:
                                </small>
                                <div class="small">{{ contract.ghichu }}</div>
                            </div>
                            {% endif %}
                            
                            {% if contract.house.loc and contract.house.loc.chu %}
                            <div class="mt-2 pt-2 border-top">
                                <small class="text-muted">
                                    <i class="fas fa-user me-1"></i>Chủ nhà:
                                </small>
                                <span class="fw-semibold">{{ contract.house.loc.chu.get_full_name|default:contract.house.loc.chu.username }}</span>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-file-contract"></i>
                        <p class="mb-0">Bạn chưa có hợp đồng thuê nào</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Bills Section -->
    <div class="col-lg-6 mb-2">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-2">
                <div class="r-section-header mb-2">
                    <h3 class="mb-0">
                        <span class="fas fa-file-invoice-dollar text-success me-2"></span>
                        Hóa đơn gần đây
                    </h3>
                </div>
                
                {% if bills %}
                    <div class="table-responsive">
                        <table class="table table-hover table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="py-2">Mô tả</th>
                                    <th class="py-2">Nhà/Phòng</th>
                                    <th class="text-end py-2">Tổng tiền</th>
                                    <th class="py-2">Trạng thái</th>
                                    <th class="py-2">Hạn</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for bill in bills %}
                                <tr class="bill-row">
                                    <td>
                                        <div class="fw-semibold">{{ bill.ten }}</div>
                                        <small class="text-muted">{{ bill.ngay_tao|date:"d/m/Y" }}</small>
                                    </td>
                                    <td>
                                        <small>{{ bill.house.ten }}</small>
                                    </td>
                                    <td class="text-end">
                                        <div class="fw-bold text-primary">
                                            {{ bill.TONG_CONG|floatformat:0 }}
                                        </div>
                                        <small class="text-muted">VNĐ</small>
                                    </td>
                                    <td>
                                        {% if bill.status == 'DaTT' %}
                                            <span class="badge bg-success badge-status">
                                                <i class="fas fa-check me-1"></i>Đã TT
                                            </span>
                                        {% elif bill.status == 'DangTT' %}
                                            <span class="badge bg-warning badge-status">
                                                <i class="fas fa-clock me-1"></i>Đang TT
                                            </span>
                                        {% elif bill.status == 'QuaHan' %}
                                            <span class="badge bg-danger badge-status">
                                                <i class="fas fa-exclamation me-1"></i>Quá hạn
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary badge-status">
                                                <i class="fas fa-times me-1"></i>Chưa TT
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ bill.duedate|date:"d/m/Y" }}</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="text-center mt-3">
                        <a href="{% url 'renter_bills' %}" class="btn btn-primary">
                            <i class="fas fa-file-invoice-dollar me-2"></i>Xem tất cả hóa đơn
                            {% if bill_stats.total > 10 %}
                            <span class="badge bg-light text-dark ms-2">{{ bill_stats.total }}</span>
                            {% endif %}
                        </a>
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-file-invoice"></i>
                        <p class="mb-0">Bạn chưa có hóa đơn nào</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Contact Info removed per request -->
{% endblock %}
